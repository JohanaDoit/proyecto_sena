{% extends "base.html" %}
{% load static %}

{# Sobreescribe el bloque de la barra lateral para que esté vacío #}
{% block sidebar_content %}{% endblock sidebar_content %} 

{% block title %}DOIT | Registrarse{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/registrarse.css' %}">
{% endblock %}

{% block content %}
    <div class="register-form-container">

        <h2 class="text-center mb-4">Nuevo Registro</h2>

        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <form method="post" enctype="multipart/form-data"> 
            {% csrf_token %} 
            
            {# Campo Tipo de Usuario (siempre visible y primero) #}
            <div class="form-group">
                {{ form.tipo_usuario.label_tag }}
                {{ form.tipo_usuario }}
                {% if form.tipo_usuario.errors %}
                    <div class="text-danger">
                        {% for error in form.tipo_usuario.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            {# Campos comunes a todos los usuarios #}
            <div class="form-group">
                {{ form.username.label_tag }}
                {{ form.username }}
                {% if form.username.errors %}
                    <div class="text-danger">
                        {% for error in form.username.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.email.label_tag }}
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="text-danger">
                        {% for error in form.email.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.password.label_tag }}
                {{ form.password }}
                {% if form.password.errors %}
                    <div class="text-danger">
                        {% for error in form.password.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.password2.label_tag }}
                {{ form.password2 }}
                {% if form.password2.errors %}
                    <div class="text-danger">
                        {% for error in form.password2.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.first_name.label_tag }}
                {{ form.first_name }}
                {% if form.first_name.errors %}
                    <div class="text-danger">
                        {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.last_name.label_tag }}
                {{ form.last_name }}
                {% if form.last_name.errors %}
                    <div class="text-danger">
                        {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.genero.label_tag }}
                {{ form.genero }}
                {% if form.genero.errors %}
                    <div class="text-danger">
                        {% for error in form.genero.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.nacionalidad.label_tag }}
                {{ form.nacionalidad }}
                {% if form.nacionalidad.errors %}
                    <div class="text-danger">
                        {% for error in form.nacionalidad.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.fechaNacimiento.label_tag }}
                {{ form.fechaNacimiento }}
                {% if form.fechaNacimiento.errors %}
                    <div class="text-danger">
                        {% for error in form.fechaNacimiento.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.tipo_documento.label_tag }}
                {{ form.tipo_documento }}
                {% if form.tipo_documento.errors %}
                    <div class="text-danger">
                        {% for error in form.tipo_documento.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            {# AQUI ESTABA LA PRIMERA INSTANCIA DUPLICADA Y MAL FORMADA DEL CAMPO numDoc. LA HE ELIMINADO. #}

            {# ESTA ES LA ÚNICA INSTANCIA CORRECTA Y CORREGIDA PARA EL CAMPO numDoc. #}
            <div class="form-group">
                {{ form.numDoc.label_tag }}
                {{ form.numDoc }}
                {% if form.numDoc.errors %}
                    <div class="text-danger">
                        {# CORRECCIÓN: Solamente un bucle 'for' para los errores #}
                        {% for error in form.numDoc.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.telefono.label_tag }} {# El campo telefono que faltaba #}
                {{ form.telefono }}
                {% if form.telefono.errors %}
                    <div class="text-danger">
                        {% for error in form.telefono.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.foto_perfil.label_tag }}
                {{ form.foto_perfil }}
                {% if form.foto_perfil.errors %}
                    <div class="text-danger">
                        {% for error in form.foto_perfil.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>


            {# DIV para los campos específicos de EXPERTO #}
            <div id="experto-fields" style="display: none;"> 
                <h3>Campos para Expertos</h3>
                <div class="form-group">
                    {{ form.experienciaTrabajo.label_tag }}
                    {{ form.experienciaTrabajo }}
                    {% if form.experienciaTrabajo.errors %}
                        <div class="text-danger">
                            {% for error in form.experienciaTrabajo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.evidenciaTrabajo.label_tag }}
                    {{ form.evidenciaTrabajo }}
                    {% if form.evidenciaTrabajo.errors %}
                        <div class="text-danger">
                            {% for error in form.evidenciaTrabajo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.hojaVida.label_tag }} 
                    {{ form.hojaVida }}
                    {% if form.hojaVida.errors %}
                        <div class="text-danger">
                            {% for error in form.hojaVida.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.hojaVida_file.label_tag }} 
                    {{ form.hojaVida_file }}
                    {% if form.hojaVida_file.errors %}
                        <div class="text-danger">
                            {% for error in form.hojaVida_file.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="g-recaptcha mt-3" data-sitekey="6LeM6WErAAAAANOcyEIgUK299_4HaIMzgGDNsVo0"></div>
            <button type="submit" class="btn btn-primary mt-3">Registrarse</button>
        </form>
    </div>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoUsuarioSelect = document.getElementById('id_tipo_usuario');
        const expertoFields = document.getElementById('experto-fields');

        function toggleExpertoFields() {
            if (tipoUsuarioSelect.value === 'experto') {
                expertoFields.style.display = 'block';
            } else {
                expertoFields.style.display = 'none';
            }
        }

        toggleExpertoFields(); // Ejecutar al cargar la página
        tipoUsuarioSelect.addEventListener('change', toggleExpertoFields);
    });
</script>

{% endblock content %}