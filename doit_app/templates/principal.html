{% extends "base.html" %}
{% load static %}

{% block title %}DOIT | Principal cliente{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/principal.css' %}">
<link rel="stylesheet" href="{% static 'css/modperf_cliente.css' %}"> 
{% endblock %}

{% block content %}
<div class="banner-bienvenida">
    <div class="contenido-banner">
        <h1>üëã ¬°Bienvenid@
            {% if user.is_authenticated %}
                {% if user.first_name %}
                    {{ user.first_name }}
                {% elif user.username %}
                    {{ user.username }}
                {% endif %}
            {% endif %}
            a
            <img src="{% static 'images/Doit_logo.png' %}" alt="Logo Doit" width="80">
        </h1>
        <form action="{% url 'busc_experto' %}" method="get" class="search-experto-form">
            <input type="text" name="q" placeholder="Buscar experto por nombre o especialidad...">
            <button type="submit">Buscar</button>
        </form>
    </div>
</div>

{# ‚úÖ Bloque de mensaje si la reserva fue aceptada #}
{% if reserva_aceptada %}
<div class="alert alert-success d-flex align-items-center mt-4" role="alert" style="gap: 15px;">
    <img src="{% if reserva_aceptada.experto_asignado.foto_perfil %}
                {{ reserva_aceptada.experto_asignado.foto_perfil.url }}
            {% else %}
                {% static 'img/default_profile.png' %}
            {% endif %}"
        alt="Foto del experto"
        class="rounded-circle"
        width="80"
        height="80">

    <div>
        <p><strong>{{ reserva_aceptada.experto_asignado.get_full_name }}</strong> ha aceptado tu reserva <strong>#{{ reserva_aceptada.id }}</strong>.</p>
        <p>Servicio: <strong>{{ reserva_aceptada.idServicios.NombreServicio }}</strong><br>
            Fecha: {{ reserva_aceptada.Fecha|date:"d/m/Y" }} a las {{ reserva_aceptada.Hora|time:"H:i" }}</p>

        <div class="mt-2">
            <a href="#" class="btn btn-outline-primary btn-sm">Contactar</a>
            <form action="{% url 'cancelar_reserva' reserva_aceptada.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm">Cancelar</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<section class="seccion-servicios">
    <div class="tarjeta-servicio">
        <h3>Reserva tu servicio</h3>

        <div class="grupo-formulario">
            <label for="categoria">Selecciona una categor√≠a:</label>
            <select id="categoria" class="form-control">
                <option value="" selected disabled>-- Elige una categor√≠a --</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.Nombre }}">{{ categoria.Nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="grupo-formulario">
            <label for="servicio">Selecciona un servicio:</label>
            <select id="servicio" disabled class="form-control">
                <option value="" selected>-- Elige un servicio --</option>
            </select>
        </div>
        <a id="reservarLink" href="{% url 'reserva' %}">
            <button id="reservarBtn" type="button" disabled class="btn btn-primary">Reservar</button>
        </a>
    </div>
</section>

<h2>Servicios:</h2>
<div>
    <h4>üïò √öltimos 3 servicios solicitados</h4>
    <ul>
        {% for reserva in ultimas_reservas %}
            <li style="margin-bottom: 10px;">
                <p><strong>Servicio:</strong> {{ reserva.idServicios.NombreServicio }}</p>
                <p><strong>Fecha:</strong> {{ reserva.Fecha|date:"d/m/Y" }}</p>
                <p><strong>Hora:</strong> {{ reserva.Hora|time:"h:i A" }}</p>
                <p><strong>Direcci√≥n:</strong> {{ reserva.direccion }}</p>
                <p><strong>Estado:</strong> {{ reserva.idEstado.Nombre }}</p>
            </li>
        {% empty %}
            <li>No has hecho reservas recientes.</li>
        {% endfor %}
    </ul>
</div>

<div class="servicios">
    <article class="servicio">
        <h2>CUIDADO PERSONAL</h2>
        <img src="{% static 'images/20.jpg' %}" alt="Foto 1">
        <p>Ofrecemos contactos con expertos en proporcionar momentos de relajaci√≥n, realzar la belleza natural y ayudar a enfrentar cada d√≠a con m√°s confianza.</p>
    </article>
    <article class="servicio">
        <h2>CUIDADO HOGAR</h2>
        <img src="{% static 'images/21.png' %}" alt="Foto 2">
        <p>Doit te conecta con un equipo de profesionales capacitados que trabaja con dedicaci√≥n, utilizando t√©cnicas innovadoras, asegur√°ndose que cada rinc√≥n brille y transmita armon√≠a.</p>
    </article>
    <article class="servicio">
        <h2>LOCATIVOS</h2>
        <img src="{% static 'images/22.png'}" alt="Foto 3">
        <p>Contactamos profesionales en servicios locativos para cubrir tus necesidades de mantenimiento, reparaci√≥n y adecuaci√≥n del hogar.</p>
    </article>
</div>

<div class="servicios-populares">
    <div class="servicios-mas-solicitados">
        <h2>‚≠ê Servicios m√°s solicitados</h2>
        <div class="servicios-grid">
            <div class="servicio-cuadro">
                <img src="{% static 'images/22.png' %}" alt="Electricista">
                <h3>Pintor</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/ex5.png' %}" alt="Plomer√≠a">
                <h3>Plomer√≠a</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/21.png' %}" alt="Aseo">
                <h3>Aseo</h3>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const categoriaSelect = document.getElementById('categoria');
    const servicioSelect = document.getElementById('servicio');
    const reservarBtn = document.getElementById('reservarBtn');
    const reservarLink = document.getElementById('reservarLink');

    const serviciosPorCategoria = {
        {% for categoria, servicios in servicios_por_categoria.items %}
            "{{ categoria }}": [
                {% for serv in servicios %}
                    {"id": "{{ serv.id }}", "nombre": "{{ serv.NombreServicio }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    categoriaSelect.addEventListener('change', () => {
        const seleccionada = categoriaSelect.value;
        servicioSelect.innerHTML = '<option value="">-- Elige un servicio --</option>';

        if (serviciosPorCategoria[seleccionada]) {
            serviciosPorCategoria[seleccionada].forEach(serv => {
                const option = document.createElement('option');
                option.value = serv.id;
                option.textContent = serv.nombre;
                servicioSelect.appendChild(option);
            });
            servicioSelect.disabled = false;
            reservarBtn.disabled = true;
            reservarLink.href = "{% url 'reserva' %}";
        } else {
            servicioSelect.disabled = true;
            reservarBtn.disabled = true;
        }
    });

    servicioSelect.addEventListener('change', () => {
        const servicioSeleccionado = servicioSelect.value;
        if (servicioSeleccionado) {
            reservarBtn.disabled = false;
            reservarLink.href = "{% url 'reserva' %}?servicio_id=" + encodeURIComponent(servicioSeleccionado);
        } else {
            reservarBtn.disabled = true;
            reservarLink.href = "{% url 'reserva' %}";
        }
    });
</script>
{% endblock extra_js %}
