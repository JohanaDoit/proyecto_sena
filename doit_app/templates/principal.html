{% extends "base.html" %}
{% load static %}

{% block title %}DOIT | Principal cliente{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/principal.css' %}">
<link rel="stylesheet" href="{% static 'css/modperf_cliente.css' %}"> 
{% endblock %}


{% block content %}
<div class="banner-bienvenida">
    <div class="contenido-banner">
        <h1>üëã ¬°Bienvenid@ 
            {% if user.is_authenticated %}
                {% if user.first_name %}
                    {{ user.first_name }}
                {% elif user.username %}
                    {{ user.username }}
                {% endif %}
            {% endif %}
            a 
            <img src="{% static 'images/Doit_logo.png' %}" alt="Logo Doit" width="80">
        </h1>
        <form action="{% url 'busc_experto' %}" method="get" class="search-experto-form" style="position:relative;">
            <input type="text" name="q" placeholder="Buscar experto por nombre o especialidad...">
            <button type="submit">Buscar</button>
        </form>
        <script src="{% static 'js/busc_experto_autocomplete.js' %}"></script>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-floating alert-{{ message.tags }}" id="floating-message-{{ forloop.counter }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

{% if request.session.mensaje_reserva %}
    {% with datos=request.session.mensaje_reserva %}
        <div class="card reserva-exitosa shadow-lg border-0 mx-auto mb-4">
            <div class="card-body p-4">
                <div class="reserva-info text-center" style="width:100%;">
                    <h4 class="mb-2 fw-bold text-primary" style="text-align:center;">¬°Reserva realizada con √©xito!</h4>
                    <ul class="list-unstyled mb-3">
                        <li><span style="font-size:1.2em;">üìå</span> <b>Servicio:</b> {{ datos.servicio }}</li>
                        <li><span style="font-size:1.2em;">üóìÔ∏è</span> <b>Fecha:</b> {{ datos.fecha }}</li>
                        <li><span style="font-size:1.2em;">‚è∞</span> <b>Hora:</b> {{ datos.hora }}</li>
                        <li><span style="font-size:1.2em;">üìç</span> <b>Ubicaci√≥n:</b> {{ datos.direccion }}</li>
                        <li><span style="font-size:1.2em;">üèôÔ∏è</span> <b>Ciudad:</b> {{ datos.ciudad }}</li>
                    </ul>
                    
                    {% if datos.reserva_id %}
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm btn-cancelar-reserva" onclick="mostrarFormularioCancelarReserva({{ datos.reserva_id }})">
                                ‚ùå Cancelar reserva
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endwith %}
{% endif %}

{% if reserva_aceptada and reserva_aceptada.idEstado.Nombre != 'Cancelado' %}
    {% if reserva_aceptada.servicio_iniciado and not reserva_aceptada.servicio_finalizado %}
    <!-- üü¢ SERVICIO EN CURSO -->
    <div class="alert alert-info d-flex align-items-center mt-4 p-3 rounded" role="alert" style="gap: 15px;">
        <img src="{% if reserva_aceptada.experto_asignado.foto_perfil %}
                    {{ reserva_aceptada.experto_asignado.foto_perfil.url }}
                {% else %}
                    {% static 'img/default_profile.png' %}
                {% endif %}"
            alt="Foto del experto"
            class="rounded-circle border"
            width="80" height="80">

        <div>
            <h5 class="mb-2">üîß {{ reserva_aceptada.experto_asignado.get_full_name }} est√° realizando tu servicio</h5>
            <p class="mb-2">Tu servicio est√° en curso. Puedes comunicarte con el experto si necesitas algo adicional.</p>

            <a href="{% url 'chat' reserva_aceptada.experto_asignado.id %}" class="btn btn-primary mb-2">
                üí¨ Chatear
            </a>

            <div class="progress mt-2" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                    role="progressbar"
                    style="width: 70%;">
                    Servicio en curso...
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- üü° RESERVA A√öN NO INICIADA (verificar que no est√© cancelada) -->
    {% if reserva_aceptada.idEstado.Nombre != 'Cancelado' %}
    <div id="mensaje-reserva" class="alert alert-success d-flex align-items-center mt-4 p-3 rounded" role="alert" style="gap: 15px;">
        <img src="{% if reserva_aceptada.experto_asignado.foto_perfil %}
                    {{ reserva_aceptada.experto_asignado.foto_perfil.url }}
                {% else %}
                    {% static 'img/default_profile.png' %}
                {% endif %}"
            alt="Foto del experto"
            class="rounded-circle border"
            width="80" height="80">

        <div>
            <h5 class="mb-2">‚úîÔ∏è ¬°Tu reserva fue aceptada!</h5>
            <p class="mb-1">
                El experto <strong>{{ reserva_aceptada.experto_asignado.get_full_name }}</strong>
                (
                {% for esp in reserva_aceptada.experto_asignado.especialidad.all %}
                    {{ esp.NombreServicio }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    Especialidad no registrada
                {% endfor %}
                ) ha aceptado tu solicitud <strong>#{{ reserva_aceptada.id }}</strong>.
            </p>

            <ul class="mb-2 ps-3">
                <li><strong>üìÖ Fecha:</strong> {{ reserva_aceptada.Fecha|date:"d/m/Y" }}</li>
                <li><strong>‚è∞ Hora:</strong> {{ reserva_aceptada.Hora|time:"H:i" }}</li>
                <li><strong>üìû Tel√©fono:</strong> {{ reserva_aceptada.experto_asignado.telefono|default:"No disponible" }}</li>
                <li><strong>üìç Direcci√≥n:</strong> {{ reserva_aceptada.experto_asignado.direccion|default:"No registrada" }}</li>
            </ul>

            <div class="botones-acciones-reserva d-flex gap-2">
                {% if reserva_aceptada.experto_asignado.id in mensajes_no_leidos %}
                    <a href="{% url 'chat' reserva_aceptada.experto_asignado.id %}" class="boton-chat-animado mensaje-nuevo">
                        üî¥ Nuevo mensaje üí¨
                    </a>
                {% else %}
                    <a href="{% url 'chat' reserva_aceptada.experto_asignado.id %}" class="btn btn-primary mb-3">
                        üí¨ Chatear
                    </a>
                {% endif %}
                <button type="button" class="boton-cancelar-animado" onclick="mostrarFormularioCancelar()">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>
    {% endif %}  <!-- Cerrar validaci√≥n de no cancelado -->
    {% endif %}  <!-- Cerrar else de servicio no iniciado -->
{% endif %}  <!-- Cerrar reserva_aceptada -->

<!-- Comentario durante el servicio -->
{% if reserva_aceptada and reserva_aceptada.idEstado.Nombre != 'Cancelado' and reserva_aceptada.servicio_iniciado and not reserva_aceptada.servicio_finalizado %}
<div class="alert alert-info mt-3">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="reserva_id" value="{{ reserva_aceptada.id }}">
        <label for="comentario_cliente"><strong>üìù Comentario para el experto:</strong></label><br>
        <textarea name="comentario_cliente" id="comentario_cliente" rows="3" cols="50"
            placeholder="Escribe algo importante que el experto deba saber..."></textarea>
        <button type="submit" class="btn btn-primary mt-2">Enviar comentario</button>
    </form>
</div>
{% endif %}

<!-- Formulario para cancelar -->
{% if reserva_aceptada and reserva_aceptada.id and reserva_aceptada.idEstado.Nombre != 'Cancelado' %}
<form id="form-cancelar" class="alert alert-warning mt-4" style="display: none; max-width: 400px;" method="post" action="{% url 'cancelar_reserva' reserva_aceptada.id %}">
    {% csrf_token %}
    <p><strong>¬øPor qu√© deseas cancelar esta reserva?</strong></p>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="motivo" id="motivo1" value="Ya no necesito el servicio" required>
        <label class="form-check-label" for="motivo1">Ya no necesito el servicio</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="motivo" id="motivo2" value="Lo ped√≠ por equivocaci√≥n">
        <label class="form-check-label" for="motivo2">Lo ped√≠ por equivocaci√≥n</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="motivo" id="motivo3" value="otra">
        <label class="form-check-label" for="motivo3">Otra (especifica)</label>
    </div>
    <div class="form-group mt-2" id="otro_motivo_container" style="display: none;">
        <label for="otro_motivo">Especifica el motivo:</label>
        <textarea name="otro_motivo" id="otro_motivo" class="form-control" rows="3"></textarea>
    </div>
    <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-danger">Confirmar cancelaci√≥n</button>
        <button type="button" class="btn btn-secondary" onclick="volverAlMensaje()">Volver al mensaje</button>
    </div>
</form>
{% endif %}

<!-- Formulario para cancelar reserva reci√©n creada -->
{% if request.session.mensaje_reserva and request.session.mensaje_reserva.reserva_id %}
<form id="form-cancelar-nueva" class="alert alert-warning mt-4" style="display: none; max-width: 500px; margin: 0 auto;" method="post" action="{% url 'cancelar_reserva' request.session.mensaje_reserva.reserva_id %}">
    {% csrf_token %}
    <div class="text-center">
        <h5 class="mb-3">¬øEst√°s seguro de que deseas cancelar esta reserva?</h5>
        <p class="mb-3">Esta acci√≥n no se puede deshacer.</p>
        
        <p><strong>¬øPor qu√© deseas cancelar esta reserva?</strong></p>
        <div class="form-check text-start">
            <input class="form-check-input" type="radio" name="motivo" id="motivo_nueva1" value="Ya no necesito el servicio" required>
            <label class="form-check-label" for="motivo_nueva1">Ya no necesito el servicio</label>
        </div>
        <div class="form-check text-start">
            <input class="form-check-input" type="radio" name="motivo" id="motivo_nueva2" value="Lo ped√≠ por equivocaci√≥n">
            <label class="form-check-label" for="motivo_nueva2">Lo ped√≠ por equivocaci√≥n</label>
        </div>
        <div class="form-check text-start">
            <input class="form-check-input" type="radio" name="motivo" id="motivo_nueva3" value="Cambi√© de opini√≥n">
            <label class="form-check-label" for="motivo_nueva3">Cambi√© de opini√≥n</label>
        </div>
        <div class="form-check text-start">
            <input class="form-check-input" type="radio" name="motivo" id="motivo_nueva4" value="otra">
            <label class="form-check-label" for="motivo_nueva4">Otra (especifica)</label>
        </div>
        <div class="form-group mt-2" id="otro_motivo_nueva_container" style="display: none;">
            <label for="otro_motivo_nueva">Especifica el motivo:</label>
            <textarea name="otro_motivo" id="otro_motivo_nueva" class="form-control" rows="3" placeholder="Escribe aqu√≠ tu motivo..."></textarea>
        </div>
        
        <div class="mt-3 d-flex gap-2 justify-content-center">
            <button type="submit" class="btn btn-danger">Confirmar cancelaci√≥n</button>
            <button type="button" class="btn btn-secondary" onclick="ocultarFormularioCancelarReserva()">Mantener reserva</button>
        </div>
    </div>
</form>
{% endif %}

<!-- Calificaci√≥n -->
{% if reserva_aceptada and reserva_aceptada.idEstado.Nombre != 'Cancelado' and reserva_aceptada.servicio_finalizado and puede_calificar %}
<div class="alert alert-success mt-3">
    <a href="{% url 'calificar_reserva' reserva_aceptada.id %}" class="btn btn-warning">
        Calificar al experto
    </a>
</div>
{% endif %}

<!-- üö´ MOSTRAR SERVICIO CANCELADO (SOLO UNA VEZ) -->
{% if reserva_cancelada_info and not reserva_aceptada %}
<div class="alert alert-floating alert-secondary d-flex align-items-center" role="alert" style="gap: 15px;" id="cancelacion-mensaje">
    <div class="text-center" style="min-width: 60px;">
        <span style="font-size: 2.5rem;">üö´</span>
    </div>
    <div>
        <h5 class="mb-2">Servicio cancelado</h5>
        <p class="mb-1">
            Has cancelado el servicio <strong>{{ reserva_cancelada_info.servicio }}</strong> 
            programado para el {{ reserva_cancelada_info.fecha }} a las {{ reserva_cancelada_info.hora }}.
        </p>
        {% if reserva_cancelada_info.motivo %}
        <p class="mb-1"><small><strong>Motivo:</strong> {{ reserva_cancelada_info.motivo }}</small></p>
        {% endif %}
        <p class="mb-0"><small class="text-muted">Puedes hacer una nueva reserva cuando lo necesites. <em>(Haz clic para cerrar)</em></small></p>
    </div>
</div>
{% endif %}

<!-- Notificaci√≥n para calificar servicio finalizado -->
{% if servicio_para_calificar and puede_calificar %}
<div class="alert d-flex align-items-center mt-3 p-3 rounded" 
     style="background: #f8f9fa; color: #495057;" 
     id="notificacion-calificar">
    
    <div class="me-3">
        <span style="font-size: 1.8rem;">‚≠ê</span>
    </div>
    
    <div class="flex-grow-1">
        <h6 class="mb-1 fw-bold text-dark">
            Servicio "{{ servicio_para_calificar.idServicios.NombreServicio }}" completado
        </h6>
        <p class="mb-2 text-muted small">
            {{ servicio_para_calificar.experto_asignado.get_full_name }} finaliz√≥ tu servicio. 
            ¬øQu√© tal fue tu experiencia?
        </p>
        
        <div class="d-flex gap-2 align-items-center">
            <a href="{% url 'calificar_reserva' servicio_para_calificar.id %}" 
               class="btn btn-primary btn-sm">
                Calificar
            </a>
            
            <button type="button" 
                    class="btn btn-link btn-sm text-muted p-0" 
                    onclick="recordarMasTarde({{ servicio_para_calificar.id }})"
                    style="text-decoration: none; font-size: 0.85rem;">
                M√°s tarde
            </button>
        </div>
    </div>
    
    <button type="button" 
            class="btn-close" 
            onclick="ocultarNotificacionCalificar()"
            style="font-size: 0.9rem;"></button>
</div>
{% endif %}

<section class="seccion-servicios">
    <div class="tarjeta-servicio">
        <h3>Reserva tu servicio</h3>

        <div class="grupo-formulario">
            <label for="categoria">Selecciona una categor√≠a:</label>
            <select id="categoria" class="form-control">
                <option value="" selected disabled>-- Elige una categor√≠a --</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.Nombre }}">{{ categoria.Nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="grupo-formulario">
            <label for="servicio">Selecciona un servicio:</label>
            <select id="servicio" disabled class="form-control">
                <option value="" selected>-- Elige un servicio --</option>
            </select>
        </div>


        <!-- ‚úÖ Enlace con par√°metros din√°micos -->
        <a id="reservarLink" href="{% url 'reserva' %}">
            <button id="reservarBtn" type="button" disabled class="btn btn-primary">Reservar</button>
        </a>
    </div>
</section>



<div class="seccion-servicios-recentes">
    <h2>Servicios:</h2>

    <details class="contenedor-desplegable-servicios">
        <summary>üïò √öltimos 3 servicios solicitados</summary>

        <div class="lista-servicios">
            <ul>
                {% for reserva in ultimas_reservas %}
                    <li>
                        <p><strong>Servicio:</strong> {{ reserva.idServicios.NombreServicio }}</p>
                        <p><strong>Fecha:</strong> {{ reserva.Fecha|date:"d/m/Y" }}</p>
                        <p><strong>Hora:</strong> {{ reserva.Hora|time:"h:i A" }}</p>
                        <p><strong>Direcci√≥n:</strong> {{ reserva.direccion }}</p>
                        <p><strong>Estado:</strong> {{ reserva.idEstado.Nombre }}</p>
                    </li>
                {% empty %}
                    <li>No has hecho reservas recientes.</li>
                {% endfor %}
            </ul>
        </div>
    </details>
</div>



<div class="servicios">
    <article class="servicio">
        <h2>CUIDADO PERSONAL</h2>
        <img src="{% static 'images/20.jpg' %}" alt="Foto 1">
        <p>Expertos que proporcionan  momentos de relajaci√≥n, realzan la belleza natural y ayudan a enfrentar cada d√≠a con m√°s confianza.</p>
    </article>
    <article class="servicio">
        <h2>CUIDADO HOGAR</h2>
        <img src="{% static 'images/21.png' %}" alt="Foto 2">
        <p> Un equipo de profesionales capacitados que trabaja con dedicaci√≥n, t√©cnicas innovadoras y asegur√°ndose que cada rinc√≥n brille y transmita armon√≠a.</p>
    </article>
    <article class="servicio">
        <h2>LOCATIVOS</h2>
        <img src="{% static 'images/22.png' %}" alt="Foto 3">
        <p>Contactamos profesionales en servicios locativos para cubrir tus necesidades de mantenimiento, reparaci√≥n y adecuaci√≥n del hogar.</p>
    </article>
</div>

<div class="servicios-populares">
    <div class="servicios-mas-solicitados">
        <h2>‚≠ê Servicios m√°s solicitados</h2>
        <div class="servicios-grid">
            <div class="servicio-cuadro">
                <img src="{% static 'images/22.png' %}" alt="Electricista">
                <h3>Pintor</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/ex5.png' %}" alt="Plomer√≠a">
                <h3>Plomer√≠a</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/21.png' %}" alt="Aseo">
                <h3>Aseo</h3>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Referencias a elementos del DOM para la secci√≥n de reserva de servicios
    const categoriaSelect = document.getElementById('categoria');
    const servicioSelect = document.getElementById('servicio');
    const reservarBtn = document.getElementById('reservarBtn');
    const reservarLink = document.getElementById('reservarLink');

    // Datos de servicios por categor√≠a (generados por Django)
    const serviciosPorCategoria = {
        {% for categoria, servicios in servicios_por_categoria.items %}
            "{{ categoria }}": [
                {% for serv in servicios %}
                    {"id": "{{ serv.id }}", "nombre": "{{ serv.NombreServicio }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // L√≥gica para el selector de categor√≠a y servicio
    if (categoriaSelect) {
        categoriaSelect.addEventListener('change', () => {
            const seleccionada = categoriaSelect.value;
            servicioSelect.innerHTML = '<option value="">-- Elige un servicio --</option>'; // Restablece opciones

            if (serviciosPorCategoria[seleccionada]) {
                serviciosPorCategoria[seleccionada].forEach(serv => {
                    const option = document.createElement('option');
                    option.value = serv.id;
                    option.textContent = serv.nombre;
                    servicioSelect.appendChild(option);
                });
                servicioSelect.disabled = false; // Habilita el selector de servicio
                reservarBtn.disabled = true; // Deshabilita el bot√≥n de reservar hasta que se elija un servicio
                reservarLink.href = "{% url 'reserva' %}"; // Resetea el enlace
            } else {
                servicioSelect.disabled = true; // Deshabilita el selector de servicio si no hay categor√≠a
                reservarBtn.disabled = true; // Deshabilita el bot√≥n
            }
        });
    }

    if (servicioSelect) {
        servicioSelect.addEventListener('change', () => {
            const servicioSeleccionado = servicioSelect.value;
            if (servicioSeleccionado) {
                reservarBtn.disabled = false; // Habilita el bot√≥n si se selecciona un servicio
                // Actualiza el enlace de reserva con el ID del servicio
                reservarLink.href = "{% url 'reserva' %}?servicio_id=" + encodeURIComponent(servicioSeleccionado);
            } else {
                reservarBtn.disabled = true; // Deshabilita el bot√≥n si no hay servicio seleccionado
                reservarLink.href = "{% url 'reserva' %}"; // Resetea el enlace
            }
        });
    }

    // Funciones para mostrar/ocultar el formulario de cancelaci√≥n de reserva
    const mensajeReserva = document.getElementById('mensaje-reserva');
    const formCancelar = document.getElementById('form-cancelar');

    window.mostrarFormularioCancelar = function() {
        if (mensajeReserva && formCancelar) {
            mensajeReserva.style.display = 'none';
            formCancelar.style.display = 'block';
        }
    }

    window.volverAlMensaje = function() {
        if (mensajeReserva && formCancelar) {
            formCancelar.style.display = 'none';
            mensajeReserva.style.display = 'flex'; // Vuelve a mostrar como flex para mantener el dise√±o
            
            // Limpiar el formulario de cancelaci√≥n al volver
            const radios = document.querySelectorAll('input[name="motivo"]');
            radios.forEach(radio => radio.checked = false); // Desmarca todos los radio buttons
            const otroMotivoContainer = document.getElementById('otro_motivo_container');
            if (otroMotivoContainer) otroMotivoContainer.style.display = 'none'; // Oculta el campo "Otra"
            const otroMotivo = document.getElementById('otro_motivo');
            if (otroMotivo) otroMotivo.value = ''; // Borra el texto del campo "Otra"
        }
    }

    // Funciones para mostrar/ocultar el formulario de cancelar reserva reci√©n creada
    window.mostrarFormularioCancelarReserva = function(reservaId) {
        const reservaExitosa = document.querySelector('.reserva-exitosa');
        const formCancelarNueva = document.getElementById('form-cancelar-nueva');
        
        if (reservaExitosa && formCancelarNueva) {
            reservaExitosa.style.display = 'none';
            formCancelarNueva.style.display = 'block';
        }
    }

    window.ocultarFormularioCancelarReserva = function() {
        const reservaExitosa = document.querySelector('.reserva-exitosa');
        const formCancelarNueva = document.getElementById('form-cancelar-nueva');
        
        if (reservaExitosa && formCancelarNueva) {
            formCancelarNueva.style.display = 'none';
            reservaExitosa.style.display = 'block';
            
            // Limpiar el formulario al volver
            const radios = document.querySelectorAll('#form-cancelar-nueva input[name="motivo"]');
            radios.forEach(radio => radio.checked = false);
            const otroMotivoNuevaContainer = document.getElementById('otro_motivo_nueva_container');
            if (otroMotivoNuevaContainer) otroMotivoNuevaContainer.style.display = 'none';
            const otroMotivoNueva = document.getElementById('otro_motivo_nueva');
            if (otroMotivoNueva) otroMotivoNueva.value = '';
        }
    }

    // L√≥gica para mostrar u ocultar el textarea "Otra" en el formulario de cancelaci√≥n
    const motivo3 = document.getElementById('motivo3'); // El radio button "Otra"
    const otroMotivoContainer = document.getElementById('otro_motivo_container'); // El div que contiene el textarea

    if (motivo3 && otroMotivoContainer) {
        document.querySelectorAll('input[name="motivo"]').forEach(input => {
            input.addEventListener('change', () => {
                // Muestra el contenedor de "Otro motivo" solo si el radio button "Otra" est√° seleccionado
                otroMotivoContainer.style.display = motivo3.checked ? 'block' : 'none';
                // Si "Otra" est√° marcado, aseg√∫rate de que el campo de texto sea requerido
                if (motivo3.checked) {
                    document.getElementById('otro_motivo').setAttribute('required', 'required');
                } else {
                    document.getElementById('otro_motivo').removeAttribute('required');
                }
            });
        });
    }

    // L√≥gica para mostrar u ocultar el textarea "Otra" en el formulario de cancelaci√≥n de reserva nueva
    const motivoNueva4 = document.getElementById('motivo_nueva4'); // El radio button "Otra"
    const otroMotivoNuevaContainer = document.getElementById('otro_motivo_nueva_container'); // El div que contiene el textarea

    if (motivoNueva4 && otroMotivoNuevaContainer) {
        document.querySelectorAll('#form-cancelar-nueva input[name="motivo"]').forEach(input => {
            input.addEventListener('change', () => {
                // Muestra el contenedor de "Otro motivo" solo si el radio button "Otra" est√° seleccionado
                otroMotivoNuevaContainer.style.display = motivoNueva4.checked ? 'block' : 'none';
                // Si "Otra" est√° marcado, aseg√∫rate de que el campo de texto sea requerido
                if (motivoNueva4.checked) {
                    document.getElementById('otro_motivo_nueva').setAttribute('required', 'required');
                } else {
                    document.getElementById('otro_motivo_nueva').removeAttribute('required');
                }
            });
        });
    }
});

// Script para mensajes flotantes que desaparecen autom√°ticamente
document.addEventListener('DOMContentLoaded', function() {
    const floatingMessages = document.querySelectorAll('.alert-floating');
    
    floatingMessages.forEach((message, index) => {
        // Determinar el tiempo de visualizaci√≥n seg√∫n el tipo de mensaje
        let displayTime = 3000; // 3 segundos por defecto
        
        // Mensaje de cancelaci√≥n se muestra por m√°s tiempo
        if (message.id === 'cancelacion-mensaje') {
            displayTime = 5000; // 5 segundos para cancelaci√≥n
        }
        
        // Hacer que el mensaje desaparezca despu√©s del tiempo especificado
        setTimeout(() => {
            message.classList.add('hide');
            
            // Remover el elemento del DOM despu√©s de la animaci√≥n
            setTimeout(() => {
                message.remove();
            }, 300); // 300ms es la duraci√≥n de la animaci√≥n slideOutRight
        }, displayTime);
        
        // Permitir cerrar el mensaje manualmente haciendo clic
        message.addEventListener('click', () => {
            message.classList.add('hide');
            setTimeout(() => {
                message.remove();
            }, 300);
        });
    });
    
    // Funci√≥n para ocultar notificaci√≥n de calificar
    window.ocultarNotificacionCalificar = function() {
        const notificacion = document.getElementById('notificacion-calificar');
        if (notificacion) {
            notificacion.style.transition = 'all 0.3s ease';
            notificacion.style.transform = 'translateX(100%)';
            notificacion.style.opacity = '0';
            setTimeout(() => {
                notificacion.remove();
            }, 300);
        }
    }

    // Funci√≥n para "Recordar m√°s tarde" - marca la notificaci√≥n como le√≠da
    window.recordarMasTarde = function(reservaId) {
        fetch('{% url "marcar_notificacion_leida" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'reserva_id=' + reservaId
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                ocultarNotificacionCalificar();
            } else {
                console.error('Error al marcar notificaci√≥n como le√≠da:', data.message);
                // Ocultar de todas formas
                ocultarNotificacionCalificar();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Ocultar de todas formas
            ocultarNotificacionCalificar();
        });
    }
});
</script>
<script src="{% static 'js/expertos_por_especialidad.js' %}"></script>
{% endblock extra_js %}
