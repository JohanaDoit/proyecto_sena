{% extends "base.html" %}
{% load static %}

{% block title %}DOIT | Dashboard de Experto{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard_experto.css' %}">
<link rel="stylesheet" href="{% static 'css/calificaciones.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Bienvenido, Experto {{ request.user.username }}!</h1>


    
{% if mostrar_mensaje_finalizado and reserva_id_calificar %}
<div id="mensaje-finalizado" class="mensaje-finalizado">
    <div class="icono-check">‚úÖ</div>
    <div class="mensaje-texto">
        Has finalizado tu servicio correctamente. Ser√°s redirigido a la calificaci√≥n...
    </div>
</div>

<script>
    setTimeout(function() {
        const mensaje = document.getElementById("mensaje-finalizado");
        mensaje.style.opacity = "0";
        mensaje.style.transform = "translateY(-20px)";
        
        setTimeout(function() {
            window.location.href = "{% url 'calificar_reserva' reserva_id_calificar %}";
        }, 700); // espera a que se desvanezca antes de redirigir
    }, 2500); // tiempo antes de empezar la animaci√≥n de salida
</script>
{% endif %}



    {% if request.user.evidenciaTrabajo %}
    <div class="mb-4">
        <h5>Evidencia de Trabajo</h5>
        {% with evidencia_url=request.user.evidenciaTrabajo.url|lower %}
            {% if ".mp4" in evidencia_url or ".webm" in evidencia_url %}
                <video controls style="max-width: 100%; max-height: 300px;">
                    <source src="{{ request.user.evidenciaTrabajo.url }}" type="video/mp4">
                    Tu navegador no soporta videos.
                </video>
            {% else %}
                <img src="{{ request.user.evidenciaTrabajo.url }}" alt="Evidencia de Trabajo" class="img-thumbnail" style="max-height: 300px;">
            {% endif %}
        {% endwith %}
    </div>
    {% endif %}

    <p>Tu especialidad:
        {% if request.user.especialidad.all %}
            {% for esp in request.user.especialidad.all %}
                <span class="badge bg-primary me-1">{{ esp.NombreServicio }}</span>
            {% empty %}
                No especificada
            {% endfor %}
        {% else %}
            No especificada
        {% endif %}
    </p>

    <div style="margin-bottom: 20px;">
        <span style="font-weight:bold;">Calificaci√≥n promedio:</span>
        <div class="star-display rating-display" data-rating="{{ promedio_calificacion|default:0 }}" data-show-number="true"></div>
    </div>


<div class="card mt-5 mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap">
        <div class="mb-2 mb-md-0">
            <button type="button" id="modoDisponible" class="btn btn-warning btn-sm me-2">Disponible</button>
            <button type="button" id="modoNoDisponible" class="btn btn-danger btn-sm">No disponible</button>
        </div>
        <div class="text-end">
            <span id="mes-actual" class="fw-bold me-2"></span>
            <small class="fst-italic">Haz clic sobre los d√≠as para marcar tu disponibilidad</small>
        </div>
    </div>

    <div class="card-body">
        <!-- Aviso de selecci√≥n -->
        <div id="rangoHoras" class="alert alert-info py-2 px-3 small mb-4">
            Selecciona un estado de disponibilidad para comenzar...
        </div>

        <!-- FORMULARIO DE DISPONIBILIDAD -->
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_disponibilidad" value="1">
            <input type="hidden" name="modo" id="modoSeleccionado">

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="hora_inicio" class="form-label">Hora inicio:</label>
                    {{ form_disponibilidad.hora_inicio }}
                </div>
                <div class="col-md-6">
                    <label for="hora_fin" class="form-label">Hora fin:</label>
                    {{ form_disponibilidad.hora_fin }}
                </div>
            </div>

            <!-- Encabezado de d√≠as de la semana -->
<!-- Encabezado de d√≠as de la semana -->
            <div id="encabezado-calendario" class="mb-2 text-center" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                <div class="dia-semana">Lun</div>
                <div class="dia-semana">Mar</div>
                <div class="dia-semana">Mi√©</div>
                <div class="dia-semana">Jue</div>
                <div class="dia-semana">Vie</div>
                <div class="dia-semana">S√°b</div>
                <div class="dia-semana">Dom</div>
            </div>            <!-- Calendario generado con JS -->
            <div id="calendario" class="d-grid gap-2" style="grid-template-columns: repeat(7, 1fr);"></div>

            <!-- Aqu√≠ se insertan inputs hidden para las fechas seleccionadas -->
            <div id="inputs-fechas-estados"></div>

            <div class="mt-4">
                <button type="submit" class="btn btn-success">Guardar Disponibilidad</button>
            </div>
        </form>

        <hr>

        <!-- Tabla de disponibilidad registrada -->
        {% if disponibilidades %}
            <h6 class="fw-bold mt-4">Disponibilidad registrada:</h6>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center mt-2">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Desde</th>
                            <th>Hasta</th>
                            <th>Tipo</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dispo in disponibilidades %}
                            <tr>
                                <td>{{ dispo.fecha|date:"d/m/Y" }}</td>
                                <td>{{ dispo.hora_inicio|time:"g:i A" }}</td>
                                <td>{{ dispo.hora_fin|time:"g:i A" }}</td>
                                <td>
                                    {% if dispo.idEstado.Nombre == 'Disponible' %}
                                        <span class="badge bg-warning text-dark">Disponible</span>
                                    {% elif dispo.idEstado.Nombre == 'No disponible' %}
                                        <span class="badge bg-danger">No disponible</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Otro</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="accion" value="eliminar_disponibilidad">
                                        <input type="hidden" name="disponibilidad_id" value="{{ dispo.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¬øEliminar esta disponibilidad?')">üóë</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mt-3">A√∫n no has registrado tu disponibilidad.</p>
        {% endif %}
    </div>
</div>
















    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}




    <hr>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Reservas Pendientes
                    <span class="badge bg-light text-primary">{{ reservas_pendientes.count }}</span>
                </h3>
            </div>
            <div class="card-body">
                {% if reservas_pendientes %}
                    <ul class="list-group">
                        {% for reserva in reservas_pendientes %}
                            {% if not reserva.experto_asignado %}
                                <li class="list-group-item position-relative">
                                    <button class="cerrar-reserva-btn" onclick="cerrarReserva(this)" title="Ocultar">√ó</button>

                                    <h5>Reserva #{{ reserva.id }} - {{ reserva.idServicios.NombreServicio }}</h5>

                                    {% if not reserva.especialidad_permitida %}
                                        <div class="alert alert-warning mt-2">
                                            No est√°s calificado para aceptar este tipo de servicio.
                                        </div>
                                    {% endif %}

                                    <p><strong>Cliente:</strong> {{ reserva.idUsuario.get_full_name|default:reserva.idUsuario.username }}</p>
                                    <p><strong>Fecha y Hora:</strong> {{ reserva.Fecha|date:"d/m/Y" }} a las {{ reserva.Hora|time:"H:i" }}</p>
                                    <p><strong>Direcci√≥n:</strong> {{ reserva.direccion }}</p>
                                    <p><strong>Descripci√≥n:</strong> {{ reserva.descripcion|default:"Sin descripci√≥n." }}</p>

                                    {% if reserva.pago_ofrecido %}
                                        <p><strong>Pago ofrecido:</strong> ${{ reserva.pago_ofrecido }}</p>
                                    {% endif %}

                                    {% if reserva.especialidad_permitida %}
                                        <form method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="accion" value="aceptar">
                                            <input type="hidden" name="reserva_id" value="{{ reserva.id }}">
                                            <button type="submit" class="btn btn-success btn-sm me-2">Aceptar</button>
                                        </form>
                                        <form action="{% url 'rechazar_reserva_experto' reserva.id %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm">Rechazar</button>
                                        </form>
                                    {% endif %}
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No tienes reservas pendientes en este momento.</p>
                {% endif %}
            </div>
        </div>
    </div>



        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        Tus Reservas Asignadas
                        <span class="badge bg-light text-success">{{ reservas_asignadas.count }}</span>
                    </h3>
                </div>
                <div class="card-body">
                    {% if reservas_asignadas %}
                        <ul class="list-group">
                            {% for reserva in reservas_asignadas %}
                                <li class="list-group-item position-relative">
                                    <button class="cerrar-reserva-btn" onclick="cerrarReserva(this)" title="Ocultar">√ó</button>

                                    <h5>Reserva #{{ reserva.id }} - {{ reserva.idServicios.NombreServicio }}</h5>
                                    <p><strong>Cliente:</strong> {{ reserva.idUsuario.get_full_name|default:reserva.idUsuario.username }}</p>
                                    <p><strong>Fecha y Hora:</strong> {{ reserva.Fecha|date:"d/m/Y" }} a las {{ reserva.Hora|time:"H:i" }}</p>
                                    <p><strong>Direcci√≥n:</strong> {{ reserva.direccion }}</p>

                                    {% if reserva.motivo_cancelacion %}
                                        <p class="text-danger">
                                            <strong>Motivo de cancelaci√≥n:</strong> {{ reserva.motivo_cancelacion }}
                                        </p>
                                    {% endif %}

                                    <div class="mt-2">
                                        {% if not reserva.servicio_iniciado %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="accion" value="iniciar_servicio">
                                                <input type="hidden" name="reserva_id" value="{{ reserva.id }}">
                                                <button type="submit" class="btn-iniciar">Iniciar Servicio</button>
                                            </form>

                                        {% elif reserva.servicio_iniciado and not reserva.servicio_finalizado %}
                                            <form method="post" class="form-finalizar-servicio">
                                                {% csrf_token %}
                                                <input type="hidden" name="accion" value="finalizar_servicio">
                                                <input type="hidden" name="reserva_id" value="{{ reserva.id }}">

                                                <label for="comentario_{{ reserva.id }}"><strong>Comentario:</strong></label><br>
                                                <textarea name="comentario" id="comentario_{{ reserva.id }}" rows="3" cols="40" placeholder="Escribe un comentario..."></textarea><br><br>

                                                <label for="duracion_{{ reserva.id }}"><strong>Duraci√≥n (HH:MM):</strong></label><br>
                                                <input type="text" name="duracion" id="duracion_{{ reserva.id }}" placeholder="Ej: 1 hora o 30 minutos">

                                                <button type="submit" class="btn-finalizar">Finalizar Servicio</button>
                                            </form>

                                        {% elif reserva.servicio_finalizado %}
                                            <div class="resumen-servicio">
                                                <p><strong>‚úÖ Servicio Finalizado</strong></p>
                                                <p><strong>Comentario:</strong> {{ reserva.comentario_durante_servicio|default:"Sin comentario" }}</p>
                                                <p><strong>Duraci√≥n:</strong>
                                                    {% if reserva.duracion_estimada %}
                                                        {{ reserva.duracion_estimada }}
                                                    {% else %}
                                                        No especificada
                                                    {% endif %}
                                                </p>
                                                {% if reserva.calificacion_experto %}
                                                    <div style="margin-top: 8px;">
                                                        {% if reserva.calificacion_experto.puntuacion %}
                                                            <div class="star-display rating-display" data-rating="{{ reserva.calificacion_experto.puntuacion }}" data-show-number="true"></div>
                                                        {% endif %}
                                                        {% if reserva.calificacion_experto.comentario %}
                                                            <span style="color:#555;"><b>Comentario al cliente:</b> {{ reserva.calificacion_experto.comentario }}</span>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    {% if not reserva.servicio_finalizado %}
                                        <div class="mt-2">
                                            {% if reserva.idUsuario.id in mensajes_no_leidos %}
                                                <a href="{% url 'chat' reserva.idUsuario.id %}" class="boton-chat-animado mensaje-nuevo">
                                                    üî¥ Nuevo mensaje üí¨
                                                </a>
                                            {% else %}
                                                <a href="{% url 'chat' reserva.idUsuario.id %}" class="boton-chat-animado">
                                                    üí¨ Chatear
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    {% if reserva.servicio_finalizado and puede_calificar_experto.reserva.id %}
                                        <div class="alert alert-info mt-2">
                                            <a href="{% url 'calificar_reserva' reserva.id %}" class="btn btn-warning">
                                                Calificar al cliente
                                            </a>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No tienes reservas asignadas actualmente.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0">Reservas Canceladas
                <span class="badge bg-light text-danger">{{ reservas_canceladas.count }}</span>
            </h3>
        </div>
        <div class="card-body">
            {% if reservas_canceladas %}
                <ul class="list-group">
                    {% for reserva in reservas_canceladas %}
                        <li class="list-group-item position-relative">
                            <button class="cerrar-reserva-btn" onclick="cerrarReserva(this)" title="Ocultar">√ó</button>

                            <h5>Reserva #{{ reserva.id }} - {{ reserva.idServicios.NombreServicio }}</h5>
                            <p><strong>Cliente:</strong> {{ reserva.idUsuario.get_full_name|default:reserva.idUsuario.username }}</p>
                            <p><strong>Fecha y Hora:</strong> {{ reserva.Fecha|date:"d/m/Y" }} a las {{ reserva.Hora|time:"H:i" }}</p>
                            <p class="text-danger"><strong>Motivo de cancelaci√≥n:</strong> {{ reserva.motivo_cancelacion }}</p>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No tienes reservas canceladas recientemente.</p>
            {% endif %}


{{ dispo_dict|json_script:"dispo-data" }}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const fechasGuardadas = JSON.parse(document.getElementById("dispo-data").textContent);

    const calendario = document.getElementById("calendario");
    const rangoHoras = document.getElementById("rangoHoras");
    const btnDisponible = document.getElementById("modoDisponible");
    const btnNoDisponible = document.getElementById("modoNoDisponible");
    const modoInput = document.getElementById("modoSeleccionado");
    const form = calendario.closest("form");
    const inputsContainer = document.getElementById("inputs-fechas-estados");

    let modoSeleccionado = null;
    let selecciones = [];

    function activarModo(modo) {
        modoSeleccionado = modo;
        modoInput.value = modo;
        if (modo === "disponible") {
            btnDisponible.classList.add("active");
            btnNoDisponible.classList.remove("active");
            rangoHoras.innerText = "üü° Est√°s seleccionando d√≠as como DISPONIBLE";
        } else if (modo === "no_disponible") {
            btnNoDisponible.classList.add("active");
            btnDisponible.classList.remove("active");
            rangoHoras.innerText = "üî¥ Est√°s seleccionando d√≠as como NO DISPONIBLE";
        }
    }

    btnDisponible.addEventListener("click", () => activarModo("disponible"));
    btnNoDisponible.addEventListener("click", () => activarModo("no_disponible"));

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const diasMes = new Date(year, month + 1, 0).getDate();
    const primerDia = new Date(year, month, 1).getDay();
    const offset = primerDia === 0 ? 6 : primerDia - 1;

    const nombresMeses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    const mesActualSpan = document.getElementById("mes-actual");
    if (mesActualSpan) {
        mesActualSpan.innerText = `${nombresMeses[month]} ${year}`;
    }

    for (let i = 0; i < offset; i++) {
        const celdaVacia = document.createElement("div");
        calendario.appendChild(celdaVacia);
    }

    function formatoFecha(dia) {
        const mesStr = (month + 1).toString().padStart(2, '0');
        const diaStr = dia.toString().padStart(2, '0');
        return `${year}-${mesStr}-${diaStr}`;
    }

    function actualizarInputsHidden() {
        inputsContainer.innerHTML = "";
        selecciones.forEach(sel => {
            const inputFecha = document.createElement("input");
            inputFecha.type = "hidden";
            inputFecha.name = "fechas[]";
            inputFecha.value = sel.fecha;
            inputsContainer.appendChild(inputFecha);

            const inputEstado = document.createElement("input");
            inputEstado.type = "hidden";
            inputEstado.name = "estados[]";
            inputEstado.value = sel.estado === "disponible" ? "Disponible" : "No disponible";
            inputsContainer.appendChild(inputEstado);
        });
    }

    for (let dia = 1; dia <= diasMes; dia++) {
        const divDia = document.createElement("div");
        divDia.classList.add("dia");
        divDia.style.cursor = "pointer";
        divDia.innerText = dia;

        const fechaClick = formatoFecha(dia);

        if (dia === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            divDia.classList.add("hoy");
        }

        // ‚úÖ Marcar las fechas guardadas al cargar
        if (fechasGuardadas && fechasGuardadas[fechaClick]) {
            const estadoBD = fechasGuardadas[fechaClick].toLowerCase().replace(" ", "_");
            divDia.classList.add(estadoBD);
            selecciones.push({ fecha: fechaClick, estado: estadoBD });
        }

        divDia.addEventListener("click", () => {
            if (!modoSeleccionado) {
                alert("Primero selecciona si est√°s disponible o no.");
                return;
            }

            const index = selecciones.findIndex(s => s.fecha === fechaClick);

            if (index >= 0) {
                if (selecciones[index].estado === modoSeleccionado) {
                    selecciones.splice(index, 1);
                    divDia.classList.remove("disponible", "no_disponible");
                } else {
                    selecciones[index].estado = modoSeleccionado;
                    divDia.classList.remove("disponible", "no_disponible");
                    divDia.classList.add(modoSeleccionado);
                }
            } else {
                selecciones.push({ fecha: fechaClick, estado: modoSeleccionado });
                divDia.classList.add(modoSeleccionado);
            }

            actualizarInputsHidden();
        });

        calendario.appendChild(divDia);
    }
});
</script>




<script src="{% static 'js/calificaciones.js' %}"></script>
{% endblock %}