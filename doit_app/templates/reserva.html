{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %} {# ¡Importante! Asegúrate de tener widget_tweaks instalado y en INSTALLED_APPS en settings.py #}

{% block title %}DOIT | Realizar Reserva{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/reserva.css' %}">
    {# Si tienes otros archivos CSS globales (como principal.css o modperf_cliente.css), #}
    {# puedes dejarlos aquí también. #}
    {# <link rel="stylesheet" href="{% static 'css/principal.css' %}"> #}
    {# <link rel="stylesheet" href="{% static 'css/modperf_cliente.css' %}"> #}
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h2>Solicitar Servicio</h2>
        
        {# Muestra el servicio seleccionado si viene en la URL #}
        {% if servicio_seleccionado %}
            <div class="alert alert-info">
                Estás solicitando el servicio: <strong>{{ servicio_seleccionado.NombreServicio }}</strong>
                <input type="hidden" name="servicio_id" value="{{ servicio_seleccionado.id }}">
            </div>
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            
            {# Mensajes de error globales del formulario #}
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="form-group">
                <label for="{{ form.idServicios.id_for_label }}">Servicio Solicitado:</label>
                {# Renderiza el campo idServicios. Si ya viene preseleccionado, será de solo lectura #}
                {% if servicio_seleccionado %}
                    <p class="form-control-static">{{ servicio_seleccionado.NombreServicio }}</p>
                    {# Puedes añadir un campo oculto para asegurarte de que el ID del servicio se envíe #}
                    <input type="hidden" name="{{ form.idServicios.name }}" value="{{ servicio_seleccionado.id }}">
                {% else %}
                    {# Si no hay servicio preseleccionado, permite al usuario elegirlo #}
                    {% render_field form.idServicios class="form-control" %}
                {% endif %}
                {% for error in form.idServicios.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.Fecha.id_for_label }}">Fecha del Servicio:</label>
                {% render_field form.Fecha type="date" class="form-control" %}
                {% for error in form.Fecha.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.Hora.id_for_label }}">Hora del Servicio:</label>
                {% render_field form.Hora type="time" class="form-control" %}
                {% for error in form.Hora.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.descripcion.id_for_label }}">Descripción del Servicio:</label>
                {% render_field form.descripcion class="form-control" rows="4" placeholder="Describe brevemente el trabajo a realizar..." %}
                {% for error in form.descripcion.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.detallesAdicionales.id_for_label }}">Detalles Adicionales (Opcional):</label>
                {% render_field form.detallesAdicionales class="form-control" rows="3" placeholder="Ej. Materiales específicos, accesos, etc." %}
                {% for error in form.detallesAdicionales.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.pago_ofrecido.id_for_label }}">Pago Ofrecido (COP, Opcional):</label>
                {% render_field form.pago_ofrecido type="number" step="0.01" min="0" class="form-control" placeholder="Ej. 50000.00" %}
                <small class="form-text text-muted">Este es un monto que ofreces al experto.</small>
                {% for error in form.pago_ofrecido.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            {# Campos de Ubicación #}
            <div class="form-group">
                <label for="{{ form.pais.id_for_label }}">País:</label>
                {% render_field form.pais class="form-control" %}
                {% for error in form.pais.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.departamento.id_for_label }}">Departamento:</label>
                {% render_field form.departamento class="form-control" disabled=True %} {# Inicialmente deshabilitado #}
                {% for error in form.departamento.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.ciudad.id_for_label }}">Ciudad:</label>
                {% render_field form.ciudad class="form-control" disabled=True %} {# Inicialmente deshabilitado #}
                {% for error in form.ciudad.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.direccion.id_for_label }}">Dirección Completa:</label>
                {% render_field form.direccion class="form-control" placeholder="Ej. Calle 123 # 45-67, Apartamento 801" %}
                {% for error in form.direccion.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="{{ form.metodoDePago.id_for_label }}">Método de Pago Preferido:</label>
                {% render_field form.metodoDePago class="form-control" %}
                {% for error in form.metodoDePago.errors %}
                    <p class="errorlist">{{ error }}</p>
                {% endfor %}
            </div>
            
            <button type="submit" class="btn btn-primary">Enviar Solicitud de Servicio</button>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Función para cargar departamentos basados en el país seleccionado
        document.getElementById('id_pais').addEventListener('change', function() {
            var paisId = this.value;
            var departamentoSelect = document.getElementById('id_departamento');
            var ciudadSelect = document.getElementById('id_ciudad');

            departamentoSelect.innerHTML = '<option value="">Cargando departamentos...</option>';
            departamentoSelect.disabled = true;
            ciudadSelect.innerHTML = '<option value="">Selecciona un departamento primero</option>';
            ciudadSelect.disabled = true;

            if (paisId) {
                fetch(`/api/departamentos/?pais_id=${paisId}`) // URL de tu API para obtener departamentos
                    .then(response => response.json())
                    .then(data => {
                        departamentoSelect.innerHTML = '<option value="">-- Selecciona un Departamento --</option>';
                        data.forEach(function(departamento) {
                            var option = document.createElement('option');
                            option.value = departamento.id;
                            option.textContent = departamento.Nombre;
                            departamentoSelect.appendChild(option);
                        });
                        departamentoSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error al cargar departamentos:', error);
                        departamentoSelect.innerHTML = '<option value="">Error al cargar</option>';
                    });
            } else {
                departamentoSelect.innerHTML = '<option value="">-- Selecciona un País primero --</option>';
            }
        });

        // Función para cargar ciudades basadas en el departamento seleccionado
        document.getElementById('id_departamento').addEventListener('change', function() {
            var departamentoId = this.value;
            var ciudadSelect = document.getElementById('id_ciudad');

            ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
            ciudadSelect.disabled = true;

            if (departamentoId) {
                fetch(`/api/ciudades/?departamento_id=${departamentoId}`) // URL de tu API para obtener ciudades
                    .then(response => response.json())
                    .then(data => {
                        ciudadSelect.innerHTML = '<option value="">-- Selecciona una Ciudad --</option>';
                        data.forEach(function(ciudad) {
                            var option = document.createElement('option');
                            option.value = ciudad.id;
                            option.textContent = ciudad.Nombre;
                            ciudadSelect.appendChild(option);
                        });
                        ciudadSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error al cargar ciudades:', error);
                        ciudadSelect.innerHTML = '<option value="">Error al cargar</option>';
                    });
            } else {
                ciudadSelect.innerHTML = '<option value="">-- Selecciona un Departamento primero --</option>';
            }
        });

        // Preseleccionar el servicio si viene en la URL
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const servicioId = urlParams.get('servicio_id');
            const servicioSelect = document.querySelector('[name="idServicios"]'); // Selecciona por el atributo 'name'

            if (servicioId && servicioSelect) {
                // Iterar sobre las opciones para encontrar y seleccionar la correcta
                for (let i = 0; i < servicioSelect.options.length; i++) {
                    if (servicioSelect.options[i].value === servicioId) {
                        servicioSelect.selectedIndex = i;
                        servicioSelect.disabled = true; // Deshabilita para que no se pueda cambiar
                        break;
                    }
                }
            }
        });

    </script>
{% endblock %}