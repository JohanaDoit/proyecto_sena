{% extends "base.html" %}
{% block title %}DOIT | Configuración de Perfil{% endblock %}
{% load static %}
{% load widget_tweaks %} {# ¡Importante! Asegúrate de tener widget_tweaks instalado #}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/modificar.css' %}">
    {# Si tienes otros archivos CSS globales (como principal.css o styles.css), #}
    {# puedes dejarlos aquí también si es necesario, pero styles.css ya debería estar en base.html #}
    {# <link rel="stylesheet" href="{% static 'css/styles.css' %}"> #}
{% endblock %}

{% block content %}

    <div class="container-perfil" id="editProfileContainer">
        <h2>Editar Información de Perfil</h2>

        {# Mostrar mensajes de Django (éxito, error, etc.) #}
        {# Hemos movido los estilos de estos mensajes a styles.css para que sean globales #}
        {% if messages %}
            <div class="messages-container"> {# Un contenedor para los mensajes globales #}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}"> {# Bootstrap-like alert classes #}
                        {# Puedes añadir un icono o spinner aquí si lo deseas #}
                        <i class="fas fa-info-circle"></i> {# Ejemplo de Font Awesome, ajusta si usas otro #}
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %} {# ¡Siempre necesario para formularios POST en Django por seguridad! #}

            {# Errores no asociados a campos específicos #}
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            {# Iterar sobre los campos para aplicar estilos consistentes con form-group y form-control #}
            {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                    
                    {# Renderiza el campo con la clase 'form-control' #}
                    {% if field.field.widget.input_type == 'file' %}
                        {# Para campos de tipo 'file' es común no usar 'form-control' o usar uno diferente #}
                        {% render_field field class="form-control-file" %} 
                    {% elif field.field.widget.input_type == 'checkbox' %}
                        {# Para checkboxes, el estilo es diferente #}
                        {% render_field field class="form-check-input" %} 
                        <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {% else %}
                        {# Para la mayoría de los campos de texto, número, email, select, textarea #}
                        {% render_field field class="form-control" %}
                    {% endif %}

                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}

                    {% for error in field.errors %}
                        <p class="errorlist">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endfor %}

            <div class="button-group">
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                {# Botón de Volver a la pantalla principal #}
                <a href="{% url 'principal' %}" class="back-button btn btn-secondary">Volver a Principal</a>
            </div>
        </form>

    </div>

{% endblock content %}

{% block extra_js %}
    <script>
        // Función para cargar departamentos basados en el país seleccionado
        document.addEventListener('DOMContentLoaded', function() {
            var paisSelect = document.getElementById('id_pais');
            var departamentoSelect = document.getElementById('id_departamento');
            var ciudadSelect = document.getElementById('id_ciudad');

            function loadDepartamentos() {
                var paisId = paisSelect.value;
                departamentoSelect.innerHTML = '<option value="">Cargando departamentos...</option>';
                departamentoSelect.disabled = true;
                ciudadSelect.innerHTML = '<option value="">Selecciona un departamento primero</option>';
                ciudadSelect.disabled = true;

                if (paisId) {
                    fetch(`/api/departamentos/?pais_id=${paisId}`)
                        .then(response => response.json())
                        .then(data => {
                            departamentoSelect.innerHTML = '<option value="">-- Selecciona un Departamento --</option>';
                            data.forEach(function(departamento) {
                                var option = document.createElement('option');
                                option.value = departamento.id;
                                option.textContent = departamento.Nombre;
                                departamentoSelect.appendChild(option);
                            });
                            departamentoSelect.disabled = false;
                            // Si ya hay un valor de departamento, seleccionarlo
                            if (departamentoSelect.dataset.selectedValue) {
                                departamentoSelect.value = departamentoSelect.dataset.selectedValue;
                                loadCiudades(); // Y cargar ciudades si ya hay departamento
                                departamentoSelect.dataset.selectedValue = ''; // Limpiar después de usar
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar departamentos:', error);
                            departamentoSelect.innerHTML = '<option value="">Error al cargar</option>';
                        });
                } else {
                    departamentoSelect.innerHTML = '<option value="">-- Selecciona un País primero --</option>';
                }
            }

            function loadCiudades() {
                var departamentoId = departamentoSelect.value;
                ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
                ciudadSelect.disabled = true;

                if (departamentoId) {
                    fetch(`/api/ciudades/?departamento_id=${departamentoId}`)
                        .then(response => response.json())
                        .then(data => {
                            ciudadSelect.innerHTML = '<option value="">-- Selecciona una Ciudad --</option>';
                            data.forEach(function(ciudad) {
                                var option = document.createElement('option');
                                option.value = ciudad.id;
                                option.textContent = ciudad.Nombre;
                                ciudadSelect.appendChild(option);
                            });
                            ciudadSelect.disabled = false;
                            // Si ya hay un valor de ciudad, seleccionarlo
                            if (ciudadSelect.dataset.selectedValue) {
                                ciudadSelect.value = ciudadSelect.dataset.selectedValue;
                                ciudadSelect.dataset.selectedValue = ''; // Limpiar después de usar
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar ciudades:', error);
                            ciudadSelect.innerHTML = '<option value="">Error al cargar</option>';
                        });
                } else {
                    ciudadSelect.innerHTML = '<option value="">-- Selecciona un Departamento primero --</option>';
                }
            }

            // Guardar valores iniciales para preseleccionar después de la carga dinámica
            if (paisSelect && departamentoSelect && ciudadSelect) {
                if (departamentoSelect.value) {
                    departamentoSelect.dataset.selectedValue = departamentoSelect.value;
                }
                if (ciudadSelect.value) {
                    ciudadSelect.dataset.selectedValue = ciudadSelect.value;
                }
                
                paisSelect.addEventListener('change', loadDepartamentos);
                departamentoSelect.addEventListener('change', loadCiudades);

                // Cargar departamentos/ciudades al inicio si ya hay un país seleccionado
                if (paisSelect.value) {
                    loadDepartamentos();
                } else {
                    // Si no hay país, asegúrate de que departamento y ciudad estén deshabilitados
                    departamentoSelect.disabled = true;
                    ciudadSelect.disabled = true;
                    departamentoSelect.innerHTML = '<option value="">-- Selecciona un País primero --</option>';
                    ciudadSelect.innerHTML = '<option value="">-- Selecciona un Departamento primero --</option>';
                }
            }
        });
    </script>
{% endblock %}